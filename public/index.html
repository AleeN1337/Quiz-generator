<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Generator Quizów</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Generator Quizów</h1>

    <textarea
      id="sourceText"
      rows="6"
      cols="80"
      placeholder="Wklej tekst źródłowy..."
    ></textarea>
    <br /><br />

    <label for="quizType">Typ quizu:</label>
    <select id="quizType">
      <option value="open-ended">Pytania otwarte</option>
      <option value="multiple-choice">Wielokrotny wybór</option>
    </select>
    <label for="outputFormat">Format pliku:</label>
    <input id="outputFormat" placeholder="pdf, csv, json..." />
    <button onclick="generateQuiz()">Generuj quiz</button>

    <hr />
    <div id="downloadContainer"></div>
    <div id="quizContainer"></div>

    <script>
      async function generateQuiz() {
        const sourceText = document.getElementById("sourceText").value;
        const quizType = document.getElementById("quizType").value;
        const outputFormat = document.getElementById("outputFormat").value;

        try {
          const response = await fetch("/generate-quiz", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sourceText, quizType, outputFormat }),
          });

          const contentType = response.headers.get("Content-Type");

          if (response.status !== 200) {
            const errorData = await response.json();
            alert("Błąd generowania quizu: " + errorData.error);
            return;
          }

          const downloadContainer =
            document.getElementById("downloadContainer");
          downloadContainer.innerHTML = "";
          if (
            contentType.includes("application/pdf") ||
            contentType.includes("text/csv")
          ) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = contentType.includes("pdf")
              ? "quiz.pdf"
              : "quiz.csv";
            link.textContent = "Pobierz quiz";
            link.className = "download-btn";
            downloadContainer.appendChild(link);
            return;
          }

          // Obsługa JSON
          const data = await response.json();
          const container = document.getElementById("quizContainer");
          container.innerHTML = "";

          if (!data.quiz || !Array.isArray(data.quiz.questions)) {
            container.innerHTML = `<p class="error">Nie udało się wygenerować quizu.</p>`;
            return;
          }

          data.quiz.questions.forEach((q, index) => {
            const div = document.createElement("div");
            div.className = "quiz-item";

            const questionHTML = `<strong>Pytanie ${index + 1}:</strong> ${
              q.question
            }<br>`;
            let optionsHTML = "";

            if (Array.isArray(q.options) && q.options.length) {
              optionsHTML = `<ul>${q.options
                .map((opt) => `<li>${opt}</li>`)
                .join("")}</ul>`;
              const correctOption =
                q.options.find((opt) =>
                  opt.trim().startsWith((q.correctAnswer || "") + ".")
                ) ||
                q.correctAnswer ||
                "";
              optionsHTML += renderAnswer(index, correctOption);
            } else {
              const openAnswer =
                q.answer || q.correctAnswer || "brak odpowiedzi";
              optionsHTML += renderAnswer(index, openAnswer);
            }

            div.innerHTML = questionHTML + optionsHTML;
            container.appendChild(div);
          });
        } catch (err) {
          alert("Wystąpił błąd podczas generowania quizu.");
          console.error(err);
        }
      }

      function renderAnswer(index, answer) {
        return `
          <button onclick="document.getElementById('ans-${index}').style.display='block'">
            Pokaż odpowiedź
          </button>
          <div id="ans-${index}" style="display:none; margin-top:5px;">
            <strong>Odpowiedź:</strong> ${answer}
          </div>
        `;
      }
    </script>
  </body>
</html>
